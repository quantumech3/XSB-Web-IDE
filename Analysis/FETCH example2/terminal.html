<!DOCTYPE html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.rawgit.com/jcubic/jquery.terminal/master/js/jquery.terminal.min.js"></script>
<link href="https://cdn.rawgit.com/jcubic/jquery.terminal/master/css/jquery.terminal.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/xhr-mock/dist/xhr-mock.js"></script>
  </head>
  <body>

    <script>
        var term = $('body').terminal();
        var re = /^___terminal::/;
         // XHR proxy that handle methods from fetch in C
        window.XMLHttpRequest = (function(xhr) {
            return function() {
                var url;
                var props = {
                    readyState: 4,
                    status: 200
                };
                var enc = new TextEncoder("utf-8");
                return new Proxy(new xhr(), {
                    get: function(target, name) {
                        if (url && ['response', 'responseText', 'status', 'readyState'].indexOf(name) != -1) {
                            if (name == 'response') {
                                var response = enc.encode(props.responseText);
                                console.log(response);
                                return response;
                            }
                            return props[name];
                        } else if (name == 'open') {
                            return function(method, open_url) {
                                if (open_url.match(re)) {
                                    url = open_url;
                                } else {
                                    return target[name].apply(target, arguments);
                                }
                            };
                        } else if (name == 'send') {
                            return function(data) {
                                if (url) {
                                    var payload = url.split('::');
                                    if (payload[1] == 'read') {
                                        term.read(
                                            payload.length > 2 ? payload[2] : '',
                                            function(text) {
                                                props.responseText = text;
                                                target.onload();
                                            }
                                        );
                                    }
                                } else {
                                    return target[name].apply(target, arguments);
                                }
                            };
                        }
                        return target[name];
                    },
                    set: function(target, name, value) {
                        target[name] = value;
                    }
                });
            };
        })(window.XMLHttpRequest);
     
         </script>
     
         <script type="text/javascript" src="terminal.js"></script>
         <script>
            var mod = start_xsb().Module
         </script>
  </body>
  
</html>